<div class="max-w-3xl mx-auto my-8 px-4">
  <mat-card>
    <mat-card-header class="mb-6">
      <mat-card-title class="flex items-center gap-2 text-2xl text-gray-800">
        <mat-icon class="text-3xl w-8 h-8">link</mat-icon>
        Vincular Pet ao Tutor
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="vinculacaoForm" (ngSubmit)="onSubmit()">
        
        <!-- Seleção de Tutor -->
        <div class="my-8">
          <h3 class="flex items-center gap-2 mb-4 text-gray-700 text-xl">
            <mat-icon class="text-blue-600">person</mat-icon>
            Tutor
          </h3>
          
          @if (tutorFromParam && selectedTutor) {
            <!-- Tutor pré-selecionado -->
            <div class="my-4">
              <mat-card class="bg-gray-100">
                <div class="flex flex-col md:flex-row items-center gap-4 p-4">
                  @if (selectedTutor.foto && selectedTutor.foto.url) {
                    <img [src]="selectedTutor.foto.url" [alt]="selectedTutor.nome" 
                         class="w-20 h-20 rounded-full object-cover border-4 border-blue-600">
                  } @else {
                    <div class="w-20 h-20 rounded-full bg-gray-300 flex items-center justify-center border-4 border-blue-600">
                      <mat-icon class="text-4xl w-10 h-10 text-gray-600">person</mat-icon>
                    </div>
                  }
                  <div class="flex-1 text-center md:text-left">
                    <h4 class="mb-2 text-xl text-gray-800 font-semibold">{{ selectedTutor.nome }}</h4>
                    <p class="my-1 text-gray-600 text-sm">CPF: {{ selectedTutor.cpf }}</p>
                    <p class="my-1 text-gray-600 text-sm">Email: {{ selectedTutor.email }}</p>
                    <p class="my-1 text-gray-600 text-sm">Telefone: {{ selectedTutor.telefone }}</p>
                  </div>
                </div>
              </mat-card>
            </div>
          } @else {
            <!-- Seletor de Tutor -->
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Selecione um Tutor</mat-label>
              <mat-select formControlName="tutorId" (selectionChange)="onTutorChange($event)">
                <mat-option value="">Selecione...</mat-option>
                @for (tutor of tutoresList; track tutor.id) {
                  <mat-option [value]="tutor.id">
                    {{ tutor.nome }} - CPF: {{ tutor.cpf }}
                  </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>person</mat-icon>
              @if (vinculacaoForm.get('tutorId')?.hasError('required') && vinculacaoForm.get('tutorId')?.touched) {
                <mat-error>Selecione um tutor</mat-error>
              }
            </mat-form-field>

            @if (selectedTutor && !tutorFromParam) {
              <div class="mt-4 animate-fade-in">
                <mat-card class="bg-gray-100">
                  <div class="flex flex-col md:flex-row items-center gap-4 p-4">
                    @if (selectedTutor.foto && selectedTutor.foto.url) {
                      <img [src]="selectedTutor.foto.url" [alt]="selectedTutor.nome" 
                           class="w-12 h-12 rounded-full object-cover border-2 border-blue-600">
                    } @else {
                      <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center border-2 border-blue-600">
                        <mat-icon class="text-2xl w-6 h-6 text-gray-600">person</mat-icon>
                      </div>
                    }
                    <div class="flex-1 text-center md:text-left">
                      <strong class="block text-base text-gray-800 mb-1">{{ selectedTutor.nome }}</strong>
                      <small class="block text-gray-600 text-xs">{{ selectedTutor.email }}</small>
                    </div>
                  </div>
                </mat-card>
              </div>
            }
          }
        </div>

        <mat-divider class="my-8"></mat-divider>

        <!-- Seleção de Pet -->
        <div class="my-8">
          <h3 class="flex items-center gap-2 mb-4 text-gray-700 text-xl">
            <mat-icon class="text-blue-600">pets</mat-icon>
            Pet
          </h3>
          
          @if (petFromParam && selectedPet) {
            <!-- Pet pré-selecionado -->
            <div class="my-4">
              <mat-card class="bg-gray-100">
                <div class="flex flex-col md:flex-row items-center gap-4 p-4">
                  @if (selectedPet.foto && selectedPet.foto.url) {
                    <img [src]="selectedPet.foto.url" [alt]="selectedPet.nome" 
                         class="w-20 h-20 rounded-full object-cover border-4 border-blue-600">
                  } @else {
                    <div class="w-20 h-20 rounded-full bg-gray-300 flex items-center justify-center border-4 border-blue-600">
                      <mat-icon class="text-4xl w-10 h-10 text-gray-600">pets</mat-icon>
                    </div>
                  }
                  <div class="flex-1 text-center md:text-left">
                    <h4 class="mb-2 text-xl text-gray-800 font-semibold">{{ selectedPet.nome }}</h4>
                    <p class="my-1 text-gray-600 text-sm">Raça: {{ selectedPet.raca }}</p>
                    <p class="my-1 text-gray-600 text-sm">Idade: {{ selectedPet.idade }} anos</p>
                  </div>
                </div>
              </mat-card>
            </div>
          } @else {
            <!-- Seletor de Pet -->
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Selecione um Pet</mat-label>
              <mat-select formControlName="petId" (selectionChange)="onPetChange($event)">
                <mat-option value="">Selecione...</mat-option>
                @for (pet of petsList; track pet.id) {
                  <mat-option [value]="pet.id">
                    {{ pet.nome }} - {{ pet.raca }} ({{ pet.idade }} anos)
                  </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>pets</mat-icon>
              @if (vinculacaoForm.get('petId')?.hasError('required') && vinculacaoForm.get('petId')?.touched) {
                <mat-error>Selecione um pet</mat-error>
              }
            </mat-form-field>

            @if (selectedPet && !petFromParam) {
              <div class="mt-4 animate-fade-in">
                <mat-card class="bg-gray-100">
                  <div class="flex flex-col md:flex-row items-center gap-4 p-4">
                    @if (selectedPet.foto && selectedPet.foto.url) {
                      <img [src]="selectedPet.foto.url" [alt]="selectedPet.nome" 
                           class="w-12 h-12 rounded-full object-cover border-2 border-blue-600">
                    } @else {
                      <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center border-2 border-blue-600">
                        <mat-icon class="text-2xl w-6 h-6 text-gray-600">pets</mat-icon>
                      </div>
                    }
                    <div class="flex-1 text-center md:text-left">
                      <strong class="block text-base text-gray-800 mb-1">{{ selectedPet.nome }}</strong>
                      <small class="block text-gray-600 text-xs">{{ selectedPet.raca }} - {{ selectedPet.idade }} anos</small>
                    </div>
                  </div>
                </mat-card>
              </div>
            }
          }
        </div>

        <!-- Botões de Ação -->
        <div class="flex flex-col md:flex-row justify-end gap-4 mt-8">
          <button mat-raised-button type="button" (click)="cancel()" [disabled]="loading" 
                  class="w-full md:w-auto min-w-[120px]">
            <mat-icon class="mr-2">close</mat-icon>
            Cancelar
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading || vinculacaoForm.invalid"
                  class="w-full md:w-auto min-w-[120px]">
            @if (loading) {
              <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
            } @else {
              <mat-icon class="mr-2">link</mat-icon>
            }
            {{ loading ? 'Processando...' : 'Vincular' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
