<div class="max-w-3xl mx-auto p-6">
  <!-- Loading -->

  @if (loading()) {
    <div class="flex justify-center items-center py-20">
      <mat-spinner></mat-spinner>
    </div>
  }

  @if (!loading() && petForm) {
    <mat-card class="shadow-md">
      <mat-card-header class="mb-6">
        <mat-card-title class="!flex !items-center !gap-3 !text-2xl !font-medium">
          <button mat-icon-button (click)="onCancel()" class="!mr-2">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <mat-icon>edit</mat-icon>
          Editar Pet: {{ originalPetName }}
        </mat-card-title>
      </mat-card-header>

      <mat-card-content class="!p-4">
        <form [formGroup]="petForm" (ngSubmit)="onSubmit()" class="flex flex-col gap-4">
          
          <!-- Upload de Foto -->
          <div class="flex flex-col items-center gap-4 p-6 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 mb-2">
            <div [class]="imagePreview ? 'relative w-48 h-48 rounded-xl overflow-hidden bg-gray-100 border-2 border-green-500' : 'relative w-48 h-48 rounded-xl overflow-hidden bg-gray-100 border-2 border-gray-300'">
              @if (imagePreview) {
                <img [src]="imagePreview" [alt]="originalPetName" class="w-full h-full object-cover">
                <button 
                  type="button" 
                  mat-mini-fab 
                  color="warn" 
                  class="!absolute !top-2 !right-2 !min-w-[36px] !min-h-[36px] !w-9 !h-9"
                  (click)="removeImage()"
                  aria-label="Remover foto">
                  <mat-icon class="!text-xl">close</mat-icon>
                </button>
              } @else {
                <mat-icon class="!absolute !top-1/2 !left-1/2 !-translate-x-1/2 !-translate-y-1/2 !text-gray-400 !text-6xl !w-16 !h-16">pets</mat-icon>
                <p class="absolute bottom-4 left-0 right-0 text-center text-gray-600 text-sm m-0">{{ currentPhotoUrl ? 'Foto atual' : 'Sem foto' }}</p>
              }
            </div>
            
            <input 
              type="file" 
              accept="image/*" 
              #fileInput 
              (change)="onFileSelected($event)"
              class="hidden">
            
            <button 
              type="button" 
              mat-raised-button 
              color="primary"
              (click)="fileInput.click()"
              [disabled]="loadingSubmit()">
              <mat-icon>{{ currentPhotoUrl ? 'change_circle' : 'upload' }}</mat-icon>
              {{ currentPhotoUrl ? 'Alterar Foto' : 'Adicionar Foto' }}
            </button>
            <p class="text-gray-600 text-xs m-0">Formatos aceitos: JPG, PNG (máx. 5MB)</p>
          </div>

          <!-- Campo Nome -->
          <mat-form-field appearance="outline" class="!w-full">
            <mat-label>Nome do Pet</mat-label>
            <input 
              matInput 
              formControlName="nome" 
              placeholder="Ex: Rex"
              [disabled]="loadingSubmit()">
            <mat-icon matPrefix class="!mr-3 !text-gray-600">badge</mat-icon>
            @if (petForm.get('nome')?.invalid && petForm.get('nome')?.touched) {
              <mat-error>{{ getErrorMessage('nome') }}</mat-error>
            }
          </mat-form-field>

          <!-- Campo Raça -->
          <mat-form-field appearance="outline" class="!w-full">
            <mat-label>Raça</mat-label>
            <input 
              matInput 
              formControlName="raca" 
              placeholder="Ex: Labrador"
              [disabled]="loadingSubmit()">
            <mat-icon matPrefix class="!mr-3 !text-gray-600">category</mat-icon>
            @if (petForm.get('raca')?.invalid && petForm.get('raca')?.touched) {
              <mat-error>{{ getErrorMessage('raca') }}</mat-error>
            }
          </mat-form-field>

          <!-- Campo Idade -->
          <mat-form-field appearance="outline" class="!w-full">
            <mat-label>Idade</mat-label>
            <input 
              matInput 
              type="number" 
              formControlName="idade" 
              placeholder="Ex: 3"
              min="0"
              max="50"
              [disabled]="loadingSubmit()">
            <mat-icon matPrefix class="!mr-3 !text-gray-600">cake</mat-icon>
            <span matSuffix>anos</span>
            @if (petForm.get('idade')?.invalid && petForm.get('idade')?.touched) {
              <mat-error>{{ getErrorMessage('idade') }}</mat-error>
            }
          </mat-form-field>

          <!-- Botões de Ação -->
          <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-gray-200">
            <button 
              type="button" 
              mat-stroked-button 
              (click)="onCancel()"
              [disabled]="loadingSubmit()"
              class="!h-11 !px-6">
              Cancelar
            </button>
            <button 
              type="submit" 
              mat-raised-button 
              color="primary"
              [disabled]="loadingSubmit() || petForm.invalid"
              class="!h-11 !px-6">
              @if (loadingSubmit()) {
                <mat-spinner diameter="20" class="!inline-block !mr-2"></mat-spinner>
              }
              {{ loadingSubmit() ? 'Salvando...' : 'Salvar Alterações' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }
</div>
